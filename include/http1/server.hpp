/**
 * @file server.hpp
 * @brief –ó–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è HTTP/1.1 —Å–µ—Ä–≤–µ—Ä–∞.
 *
 * –†–µ–∞–ª–∏–∑—É–µ—Ç –ø—Ä–æ—Å—Ç–æ–π HTTP/1.1 —Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç GET –∏ HEAD –∑–∞–ø—Ä–æ—Å—ã.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–∑–æ–≤–æ–π —Å–µ—Ç–µ–≤–æ–π —Å–≤—è–∑–Ω–æ—Å—Ç–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–∫—Å–∏.
 * –ù–µ —Ç—Ä–µ–±—É–µ—Ç TLS ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —á–∏—Å—Ç–æ–º TCP.
 *
 * @author Telian Edward <telianedward@icloud.com>
 * @assisted-by AI-Assistant
 * @date 2025-10-24
 * @version 1.0
 * @license MIT
 */
#pragma once

#include <iostream>
#include <string>
#include <vector>
#include <unordered_map>
#include <atomic>
#include <sys/socket.h>
#include <netinet/in.h>
#include <unistd.h>
#include <fcntl.h>
#include <arpa/inet.h>
#include <csignal>
#include <cerrno>
#include <sys/select.h>
#include <thread>
#include "../logger/logger.h"
#include <openssl/ssl.h>
#include <openssl/err.h>

/**
 * @brief –ö–ª–∞—Å—Å HTTP/1.1 —Å–µ—Ä–≤–µ—Ä–∞.
 *
 * –°–ª—É—à–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–º –ø–æ—Ä—Ç—É –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç HTTP/1.1 –∑–∞–ø—Ä–æ—Å—ã.
 * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç: GET, HEAD, favicon.ico, main.css, main.js.
 */
class Http1Server {
public:
    /**
     * @brief –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä.
     * @param port –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å —Å–µ—Ä–≤–µ—Ä (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 8587).
     * @param backend_ip IP-–∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ –≤ –†–æ—Å—Å–∏–∏.
     * @param backend_port –ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞ –≤ –†–æ—Å—Å–∏–∏.
     */
    explicit Http1Server(int port = 8587, const std::string& backend_ip = "10.8.0.11", int backend_port = 8587);

        /**
     * @brief –î–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–ª–∞—Å—Å–∞ Http1Server.
     *
     * –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã: SSL-–∫–æ–Ω—Ç–µ–∫—Å—Ç, SSL-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.
     */
    ~Http1Server();

    /**
     * @brief –ó–∞–ø—É—Å–∫–∞–µ—Ç HTTP/1.1 —Å–µ—Ä–≤–µ—Ä.
     * @return true –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏, false –ø—Ä–∏ –æ—à–∏–±–∫–µ.
     */
    bool run();

    /**
     * @brief –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç HTTP/1.1 —Å–µ—Ä–≤–µ—Ä.
     */
    void stop();

private:
    // üëá –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫
    struct PendingSend {
        int fd;           ///< –°–æ–∫–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        const char* ptr;  ///< –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –Ω–∞—á–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö
        size_t len;       ///< –û–±—â–∞—è –¥–ª–∏–Ω–∞ –¥–∞–Ω–Ω—ã—Ö
        size_t sent;      ///< –°–∫–æ–ª—å–∫–æ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
    };

    /**
 * @brief –ö–∞—Ä—Ç–∞ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫.
 *
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ EAGAIN/EWOULDBLOCK.
 * –ö–ª—é—á ‚Äî client_fd, –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ PendingSend.
 */
    // üü¢ –°–ù–ê–ß–ê–õ–ê –ò–î–£–¢ –ü–û–õ–Ø, –ö–û–¢–û–†–´–ï –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–£–Æ–¢–°–Ø –í –ö–û–ù–°–¢–†–£–ö–¢–û–†–ï
    int listen_fd_;          ///< –°–æ–∫–µ—Ç –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    int port_;               ///< –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Å–ª—É—à–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä
    std::string backend_ip_; ///< IP —Å–µ—Ä–≤–µ—Ä–∞ –≤ –†–æ—Å—Å–∏–∏
    int backend_port_;       ///< –ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞ –≤ –†–æ—Å—Å–∏–∏
    volatile sig_atomic_t running_{true}; ///< –§–ª–∞–≥ —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞

    // üü° –ó–ê–¢–ï–ú ‚Äî SSL-–ü–û–õ–Ø
    SSL_CTX* ssl_ctx_;                  ///< SSL-–∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è TLS
    std::unordered_map<int, SSL*> ssl_connections_; ///< –ö–∞—Ä—Ç–∞: client_fd ‚Üí SSL*

    // üü† –ó–ê–¢–ï–ú ‚Äî –ö–ê–†–¢–´ –°–û–ï–î–ò–ù–ï–ù–ò–ô
       /**
     * @brief –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏.
     * @details –°–æ–¥–µ—Ä–∂–∏—Ç:
     *          - backend_fd: –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å–æ–∫–µ—Ç–∞ –±—ç–∫–µ–Ω–¥–∞.
     *          - ssl: —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ SSL-–æ–±—ä–µ–∫—Ç (nullptr, –µ—Å–ª–∏ –Ω–µ—Ç TLS).
     *          - handshake_done: true, –µ—Å–ª–∏ TLS handshake –∑–∞–≤–µ—Ä—à—ë–Ω.
     */
    struct ConnectionInfo {
        int backend_fd;           ///< –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å–æ–∫–µ—Ç–∞ –±—ç–∫–µ–Ω–¥–∞
        SSL* ssl;                 ///< –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ SSL-–æ–±—ä–µ–∫—Ç (nullptr, –µ—Å–ª–∏ –Ω–µ—Ç TLS)
        bool handshake_done;      ///< true, –µ—Å–ª–∏ TLS handshake –∑–∞–≤–µ—Ä—à—ë–Ω
    };

    // üü¢ –ö–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π: client_fd ‚Üí ConnectionInfo
    std::unordered_map<int, ConnectionInfo> connections_; ///< –ö–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
/**
 * @brief –°–æ–∑–¥–∞–µ—Ç –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Å–æ–∫–µ—Ç—É —Å–µ—Ä–≤–µ—Ä–∞ –≤ –†–æ—Å—Å–∏–∏.
 * @return –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å–æ–∫–µ—Ç–∞ –∏–ª–∏ -1 –ø—Ä–∏ –æ—à–∏–±–∫–µ.
 */
[[nodiscard]] int connect_to_backend() noexcept;

    /**
     * @brief –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π —Ä–µ–∂–∏–º —Å–æ–∫–µ—Ç–∞.
     * @param fd –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å–æ–∫–µ—Ç–∞.
     * @return true –ø—Ä–∏ —É—Å–ø–µ—Ö–µ, false –ø—Ä–∏ –æ—à–∏–±–∫–µ.
     */
    [[nodiscard]] bool set_nonblocking(int fd) noexcept;

    /**
     * @brief –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤–æ–µ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
     */
    void handle_new_connection() noexcept;

    /**
     * @brief –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞.
     */
    void handle_io_events() noexcept;

    /**
     * @brief –ü–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ —Å–µ—Ä–≤–µ—Ä–æ–º.
     * @param from_fd –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å–æ–∫–µ—Ç–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞.
     * @param to_fd –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å–æ–∫–µ—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.
     * @return true, –µ—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ, false ‚Äî –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å.
     */
    [[nodiscard]] bool forward_data(int from_fd, int to_fd) noexcept;




};