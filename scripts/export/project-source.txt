

// "quic_udp_proxy.cpp"
/**
 * @file quic_udp_proxy.cpp
 * @brief –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç–æ–¥–æ–≤, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º .h —Ñ–∞–π–ª–µ.
 *
 * –ó–¥–µ—Å—å —Ä–µ–∞–ª–∏–∑—É—é—Ç—Å—è –º–µ—Ç–æ–¥—ã, —É—Ç–∏–ª–∏—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞.
 * –§–∞–π–ª —Ä–∞–±–æ—Ç–∞–µ—Ç —Å PostgreSQL —á–µ—Ä–µ–∑ libpqxx –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º C++23.
 *
 * @author Telian Edward <telianedward@icloud.com>
 * @assisted-by AI-Assistant
 * @date 2025-09-29
 * @version 1.0
 * @license MIT
 */

#include "quic_udp_proxy.hpp"
#include "include/quic_udp_deduplicator.hpp"

#include "server/logger.h"
#include <sys/socket.h>
#include <netinet/in.h>
#include <unistd.h>
#include <fcntl.h>
#include <arpa/inet.h>
#include <csignal>
#include <cerrno>
#include <sys/select.h>
#include <cstdio>
#include <ctime>  // –î–ª—è std::time(nullptr)
#include <random> // –î–ª—è std::mt19937, std::uniform_int_distribution

// === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö ===

// session_map —Ç–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω–∏—Ç ClientKey ‚Üí ClientKey
std::unordered_map<ClientKey, ClientKey, ClientKeyHash> session_map;
// deduplicator ‚Äî —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∞—Å—Å–∞ –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
Deduplicator deduplicator;
// === –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π ===

int set_nonblocking(int fd) noexcept
{
    int flags = fcntl(fd, F_GETFL, 0);
    if (flags == -1)
        return -1;
    return fcntl(fd, F_SETFL, flags | O_NONBLOCK);
}

bool get_external_ip(std::string &ip_out) noexcept
{
    int sock = socket(AF_INET, SOCK_DGRAM, 0);
    if (sock < 0)
        return false;

    struct sockaddr_in temp_addr{};
    temp_addr.sin_family = AF_INET;
    temp_addr.sin_port = htons(53);
    inet_pton(AF_INET, "8.8.8.8", &temp_addr.sin_addr);

    if (::connect(sock, (struct sockaddr *)&temp_addr, sizeof(temp_addr)) < 0)
    {
        ::close(sock);
        return false;
    }

    socklen_t len = sizeof(temp_addr);
    if (getsockname(sock, (struct sockaddr *)&temp_addr, &len) < 0)
    {
        ::close(sock);
        return false;
    }

    ip_out = inet_ntoa(temp_addr.sin_addr);
    ::close(sock);
    return true;
}

void print_hex(const uint8_t *data, size_t len, const std::string &label) noexcept
{
    if (!data || len == 0)
    {
        std::printf("[DEBUG] [%s:%d] %s: –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ\n", __FILE__, __LINE__, label.c_str());
        return;
    }

    std::printf("[DEBUG] [%s:%d] %s: ", __FILE__, __LINE__, label.c_str());
    for (size_t i = 0; i < std::min(len, 32UL); ++i)
    {
        std::printf("%02x ", data[i]);
    }
    if (len > 32)
        std::printf("...");
    std::printf("\n");
}

volatile sig_atomic_t running = true;

void signal_handler(int sig)
{
    std::printf("[INFO] [quic_udp_proxy.cpp:%d] –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª %d. –û—Å—Ç–∞–Ω–æ–≤–∫–∞...\n", __LINE__, sig);
    running = false;
}

// === –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª ===

int main()
{
    int udp_fd = -1, wg_fd = -1;
    struct sockaddr_in client_addr{}, backend_addr{}, listen_addr{};
    socklen_t client_len = sizeof(client_addr);
    socklen_t backend_len = sizeof(backend_addr);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª
    std::random_device rd;
    std::mt19937 gen(rd());

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
    std::signal(SIGINT, signal_handler);
    std::signal(SIGTERM, signal_handler);

    // --- –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–∫–µ—Ç–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (–ø–æ—Ä—Ç 443) ---
    udp_fd = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);
    if (udp_fd < 0)
    {
        std::perror("[ERROR] socket udp_fd failed");
        return 1;
    }

    int opt = 1;
    if (setsockopt(udp_fd, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt)) < 0)
    {
        std::perror("[ERROR] setsockopt SO_REUSEADDR failed");
    }
    if (setsockopt(udp_fd, SOL_SOCKET, SO_REUSEPORT, &opt, sizeof(opt)) < 0)
    {
        std::perror("[ERROR] setsockopt SO_REUSEPORT failed");
    }

    if (set_nonblocking(udp_fd) == -1)
    {
        std::perror("[ERROR] set_nonblocking udp_fd failed");
        ::close(udp_fd);
        return 1;
    }

    // --- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–æ—Ä—Ç—É ---
    memset(&listen_addr, 0, sizeof(listen_addr));
    listen_addr.sin_family = AF_INET;
    listen_addr.sin_addr.s_addr = INADDR_ANY;
    listen_addr.sin_port = htons(LISTEN_PORT);

    if (bind(udp_fd, (struct sockaddr *)&listen_addr, sizeof(listen_addr)) < 0)
    {
        std::perror("[ERROR] bind udp_fd failed");
        ::close(udp_fd);
        return 1;
    }

    // --- –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–∫–µ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –†–§ ---
    wg_fd = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);
    if (wg_fd < 0)
    {
        std::perror("[ERROR] socket wg_fd failed");
        ::close(udp_fd);
        return 1;
    }

    if (set_nonblocking(wg_fd) == -1)
    {
        std::perror("[ERROR] set_nonblocking wg_fd failed");
        ::close(udp_fd);
        ::close(wg_fd);
        return 1;
    }

    memset(&backend_addr, 0, sizeof(backend_addr));
    backend_addr.sin_family = AF_INET;
    inet_pton(AF_INET, BACKEND_IP, &backend_addr.sin_addr);
    backend_addr.sin_port = htons(BACKEND_PORT);

    std::printf("[INFO] [quic_udp_proxy.cpp:%d] –ó–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É %d, —Å–ª—É—à–∞–µ—Ç 0.0.0.0, –±—ç–∫–µ–Ω–¥: %s:%d\n",
                __LINE__, LISTEN_PORT, BACKEND_IP, BACKEND_PORT);

    char buf[MAX_PACKET_SIZE];
    fd_set read_fds;

    while (running)
    {
        FD_ZERO(&read_fds);
        FD_SET(udp_fd, &read_fds);
        FD_SET(wg_fd, &read_fds);
        int max_fd = std::max(udp_fd, wg_fd);

        timeval timeout{.tv_sec = 0, .tv_usec = 100000};
        int activity = select(max_fd + 1, &read_fds, nullptr, nullptr, &timeout);
        if (activity < 0 && errno != EINTR)
        {
            std::fprintf(stderr, "[ERROR] [quic_udp_proxy.cpp:%d] select error: %s\n", __LINE__, strerror(errno));
            continue;
        }
        // === –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–õ–ò–ï–ù–¢ ‚Üí –°–ï–†–í–ï–† ===
        if (FD_ISSET(udp_fd, &read_fds))
        {
            // === –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ ===
            // n ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –±–∞–π—Ç.
            // buf ‚Äî –±—É—Ñ–µ—Ä, –≤ –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø–∏—Å–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç–∞.
            // client_addr ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è IP-–∞–¥—Ä–µ—Å –∏ –ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–∞.
            // client_len ‚Äî —Ä–∞–∑–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã client_addr.
            ssize_t n = recvfrom(udp_fd, buf, sizeof(buf), 0,
                                 (struct sockaddr *)&client_addr, &client_len);

            if (n < 0 || static_cast<size_t>(n) >= MAX_PACKET_SIZE)
            {
                if (errno != EAGAIN && errno != EWOULDBLOCK)
                {
                    LOG_ERROR("recvfrom client failed: {}", strerror(errno));
                }
                continue;
            }

            // === –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ IP-–∞–¥—Ä–µ—Å–∞ –∏ –ø–æ—Ä—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ===
            // client_ip ‚Äî —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ IPv4-–∞–¥—Ä–µ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "192.168.1.100").
            // –§—É–Ω–∫—Ü–∏—è inet_ntoa –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç 32-–±–∏—Ç–Ω–æ–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (–≤ —Å–µ—Ç–µ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ –±–∞–π—Ç) –≤ —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ "A.B.C.D".
            // –ê—Ä–≥—É–º–µ–Ω—Ç: client_addr.sin_addr.s_addr ‚Äî —ç—Ç–æ –ø–æ–ª–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã sockaddr_in, —Å–æ–¥–µ—Ä–∂–∞—â–µ–µ IP-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞.
            std::string client_ip = inet_ntoa(client_addr.sin_addr);

            // client_port ‚Äî –Ω–æ–º–µ—Ä –ø–æ—Ä—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–∏–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
            // –§—É–Ω–∫—Ü–∏—è ntohs –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç 16-–±–∏—Ç–Ω–æ–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –∏–∑ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ –±–∞–π—Ç (big-endian) –≤ –ø–æ—Ä—è–¥–æ–∫ —Ö–æ—Å—Ç–∞ (host byte order).
            // –ê—Ä–≥—É–º–µ–Ω—Ç: client_addr.sin_port ‚Äî —ç—Ç–æ –ø–æ–ª–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã sockaddr_in, —Å–æ–¥–µ—Ä–∂–∞—â–µ–µ –ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Å–µ—Ç–µ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ –±–∞–π—Ç.
            uint16_t client_port = ntohs(client_addr.sin_port);

            LOG_INFO("=== [CLIENT ‚Üí SERVER] ===");
            LOG_INFO("–ü–æ–ª—É—á–µ–Ω–æ {} –±–∞–π—Ç –æ—Ç {}:{}",
                     n,
                     client_ip.c_str(),
                     client_port);
            // –í—ã–≤–æ–¥–∏–º hex-–¥–∞–º–ø –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.
            print_hex(reinterpret_cast<uint8_t *>(buf), static_cast<size_t>(n), "HEADER");
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–∫–µ—Ç–∞. QUIC-–∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–æ—Ä–æ—á–µ 6 –±–∞–π—Ç.
            if (n < 6)
            {
                LOG_WARN("–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –ø–∞–∫–µ—Ç ({}) –±–∞–π—Ç", n);
                continue;
            }
            // === –ü–∞—Ä—Å–∏–Ω–≥ —Ç–∏–ø–∞ –ø–∞–∫–µ—Ç–∞ ===
            // packet_type ‚Äî –ø–µ—Ä–≤—ã–π –±–∞–π—Ç –ø–∞–∫–µ—Ç–∞, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π —Ç–∏–ø –∑–∞–≥–æ–ª–æ–≤–∫–∞.
            uint8_t packet_type = buf[0];
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–∞–∫–µ—Ç Long Header (–±–∏—Ç—ã 7-6 == 11).
            if ((packet_type & 0xC0) != 0xC0)
            {
                LOG_DEBUG("Short Header ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º");
                continue;
            }

            // === –û–±—Ä–∞–±–æ—Ç–∫–∞ Retry-–ø–∞–∫–µ—Ç–∞ ===
            // –ï—Å–ª–∏ –ø–∞–∫–µ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0xF0 –∏ –µ–≥–æ –¥–ª–∏–Ω–∞ >= 9, —ç—Ç–æ Retry-–ø–∞–∫–µ—Ç.
            if (n >= 9 && static_cast<unsigned char>(buf[0]) == 0xF0)
            {
                LOG_INFO("Received Retry packet");
                // === –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ Retry-–ø–∞–∫–µ—Ç–∞ ===
                // token_offset ‚Äî —Å–º–µ—â–µ–Ω–∏–µ –¥–æ —Ç–æ–∫–µ–Ω–∞ (–±–∞–π—Ç 9).
                size_t token_offset = 9;
                // token_len ‚Äî –¥–ª–∏–Ω–∞ —Ç–æ–∫–µ–Ω–∞ (—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±–∞–π—Ç–µ 9).
                size_t token_len = buf[token_offset];
                // token ‚Äî –≤–µ–∫—Ç–æ—Ä, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Å–∞–º —Ç–æ–∫–µ–Ω.
                std::vector<uint8_t> token(buf + token_offset + 1, buf + token_offset + 1 + token_len);
                // === –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ ===
                // key ‚Äî –æ–±—ä–µ–∫—Ç ClientKey, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–∞–∫ –∫–ª—é—á –≤ session_map.
                ClientKey key{};
                key.addr = client_addr.sin_addr.s_addr; // IPv4-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞.
                key.port = client_addr.sin_port;        // –ü–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–∞.
                                                        // cid ‚Äî –ø–µ—Ä–≤—ã–µ 8 –±–∞–π—Ç SCID –∏–∑ Retry-–ø–∞–∫–µ—Ç–∞.
                std::memset(key.cid, 0, 8);
                std::memcpy(key.cid, buf + 9, 8); // –ü–µ—Ä–≤—ã–µ 8 –±–∞–π—Ç –ø–æ—Å–ª–µ —Ç–æ–∫–µ–Ω–∞ ‚Äî —ç—Ç–æ SCID.

                // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ session_map ===
                key.token = token;
                session_map[key] = key;

                // === –ü–µ—Ä–µ—Å—ã–ª–∫–∞ Retry-–ø–∞–∫–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É ===
                ssize_t sent = sendto(udp_fd, buf, n, 0,
                                      (struct sockaddr *)&client_addr, sizeof(client_addr));

                if (sent < 0)
                {
                    LOG_ERROR("sendto client failed: {}", strerror(errno));
                }
                else
                {
                    LOG_INFO("Retry packet sent to client");
                }
                continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —ç—Ç–æ–≥–æ –ø–∞–∫–µ—Ç–∞.
            }

            // === –ü–∞—Ä—Å–∏–Ω–≥ –≤–µ—Ä—Å–∏–∏ QUIC ===
            // version ‚Äî 32-–±–∏—Ç–Ω–æ–µ —á–∏—Å–ª–æ, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–µ–µ –≤–µ—Ä—Å–∏—é QUIC.
            uint32_t version = (buf[1] << 24) | (buf[2] << 16) | (buf[3] << 8) | buf[4];

            // === –ü–∞—Ä—Å–∏–Ω–≥ –¥–ª–∏–Ω CID ===
            // pos ‚Äî —Å–º–µ—â–µ–Ω–∏–µ –¥–æ –±–∞–π—Ç–∞ –¥–ª–∏–Ω CID (–±–∞–π—Ç 5).
            size_t pos = 5;
            // dcil ‚Äî –¥–ª–∏–Ω–∞ DCID (–≤–µ—Ä—Ö–Ω–∏–µ 4 –±–∏—Ç–∞ –±–∞–π—Ç–∞ 5).
            uint8_t dcil = buf[pos];
            // scil ‚Äî –¥–ª–∏–Ω–∞ SCID (–Ω–∏–∂–Ω–∏–µ 4 –±–∏—Ç–∞ –±–∞–π—Ç–∞ 5).
            uint8_t scil = buf[pos + 1];

            LOG_INFO("QUIC –í–µ—Ä—Å–∏—è: 0x{:08x}, DCIL={}, SCIL={}",
                     version,
                     static_cast<int>(dcil),
                     static_cast<int>(scil));

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–ª–∏–Ω CID.
            if (dcil == 0 || scil == 0 || pos + 2 + dcil + scil > static_cast<size_t>(n))
            {
                LOG_WARN("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ CID –¥–ª–∏–Ω—ã");
                continue;
            }
            // === –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ SCID ===
            // scid ‚Äî —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ SCID –≤ –ø–∞–∫–µ—Ç–µ.
            uint8_t *scid = reinterpret_cast<uint8_t *>(&buf[pos + 2 + dcil]);

            // === –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—é—á–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–µ—Å—Å–∏–∏ ===
            ClientKey key{};
            key.addr = client_addr.sin_addr.s_addr;
            key.port = client_addr.sin_port;
            std::memset(key.cid, 0, 8);
            std::memcpy(key.cid, scid, std::min(static_cast<size_t>(scil), 8UL));

            // === –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç —Å –ø–æ–º–æ—â—å—é Deduplicator ===
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç PacketInfo –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ Deduplicator
            // info ‚Äî –æ–±—ä–µ–∫—Ç —Ç–∏–ø–∞ Deduplicator::PacketInfo, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–∫–µ—Ç–µ.
            Deduplicator::PacketInfo info;
            // info.scid ‚Äî –≤–µ–∫—Ç–æ—Ä, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π SCID –∏–∑ –ø–∞–∫–µ—Ç–∞.
            info.scid = std::vector<uint8_t>(scid, scid + scil);
            // info.token ‚Äî –≤–µ–∫—Ç–æ—Ä, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Ç–æ–∫–µ–Ω (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—É—Å—Ç–æ–π, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –ø–∞–∫–µ—Ç).
            info.token = {}; // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Ç–æ–∫–µ–Ω –ø—É—Å—Ç–æ–π

            // === –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ Packet Number ===
            size_t cid_offset = pos + 2;                 // –°–º–µ—â–µ–Ω–∏–µ –¥–æ CID
            size_t pn_offset = cid_offset + dcil + scil; // –°–º–µ—â–µ–Ω–∏–µ –¥–æ Packet Number

            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–∞–∫–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª–∏–Ω–Ω—ã–π
            if (pn_offset >= static_cast<size_t>(n))
            {
                LOG_WARN("–ü–∞–∫–µ—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è Packet Number");
                continue;
            }

            // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ Packet Number (–º–∞–∫—Å–∏–º—É–º 4 –±–∞–π—Ç–∞)
            uint64_t packet_number = 0;
            for (size_t i = 0; i < 4 && pn_offset + i < static_cast<size_t>(n); ++i)
            {
                packet_number = (packet_number << 8) | buf[pn_offset + i];
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–∞–∫–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–º
            // deduplicator.is_duplicate ‚Äî –º–µ—Ç–æ–¥ –∫–ª–∞—Å—Å–∞ Deduplicator, –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–π, –±—ã–ª –ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω —Ç–∞–∫–æ–π –ø–∞–∫–µ—Ç.
            // –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
            //   key ‚Äî –∫–ª—é—á –∫–ª–∏–µ–Ω—Ç–∞ (IP, –ø–æ—Ä—Ç, SCID).
            //   info.scid ‚Äî SCID –∏–∑ –ø–∞–∫–µ—Ç–∞.
            //   info.token ‚Äî —Ç–æ–∫–µ–Ω –∏–∑ –ø–∞–∫–µ—Ç–∞.
            if (deduplicator.is_duplicate(key, info.scid, info.token, packet_number))
            {
                // –ï—Å–ª–∏ –ø–∞–∫–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–π ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ–≥–æ.
                LOG_INFO("–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–∞–∫–µ—Ç ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º");
                continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
            }

            // –≠—Ç–æ –ø–µ—Ä–≤—ã–π –ø–∞–∫–µ—Ç ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–º –≤ Deduplicator
            // deduplicator.add_packet ‚Äî –º–µ—Ç–æ–¥ –∫–ª–∞—Å—Å–∞ Deduplicator, —Å–æ—Ö—Ä–∞–Ω—è—é—â–∏–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–≤–æ–º –ø–∞–∫–µ—Ç–µ.
            // –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
            //   key ‚Äî –∫–ª—é—á –∫–ª–∏–µ–Ω—Ç–∞.
            //   info ‚Äî –æ–±—ä–µ–∫—Ç PacketInfo, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π SCID –∏ —Ç–æ–∫–µ–Ω.
            deduplicator.add_packet(key, info);

            // === –ü–æ–∏—Å–∫ —Å–µ—Å—Å–∏–∏ –≤ session_map ===
            // it ‚Äî –∏—Ç–µ—Ä–∞—Ç–æ—Ä, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç –≤ session_map.
            auto it = session_map.find(key);

            if (it == session_map.end())
            {
                // –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è
                // session_map[key] = key ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –≤ session_map.
                session_map[key] = key;
                LOG_INFO("–ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è: {}:{} ‚Üí SCID: {:02x}{:02x}{:02x}{:02x}{:02x}{:02x}{:02x}{:02x}",
                         client_ip.c_str(),
                         client_port,
                         key.cid[0],
                         key.cid[1],
                         key.cid[2],
                         key.cid[3],
                         key.cid[4],
                         key.cid[5],
                         key.cid[6],
                         key.cid[7]);
            }
            else
            {
                LOG_DEBUG("Reuse SCID: {:02x}{:02x}{:02x}{:02x}{:02x}{:02x}{:02x}{:02x}",
                          key.cid[0],
                          key.cid[1],
                          key.cid[2],
                          key.cid[3],
                          key.cid[4],
                          key.cid[5],
                          key.cid[6],
                          key.cid[7]);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –≤ –ø–∞–∫–µ—Ç
            // it != session_map.end() ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Å–µ—Å—Å–∏—è.
            // it->second.token.size() > 0 ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ —Ç–æ–∫–µ–Ω –≤ —Å–µ—Å—Å–∏–∏.
            if (it != session_map.end() && it->second.token.size() > 0)
            {
                // token_offset ‚Äî —Å–º–µ—â–µ–Ω–∏–µ –¥–æ —Ç–æ–∫–µ–Ω–∞ –≤ –ø–∞–∫–µ—Ç–µ (–±–∞–π—Ç 9).
                size_t token_offset = 9;
                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–ª–∏–Ω—É —Ç–æ–∫–µ–Ω–∞ –≤ –±–∞–π—Ç 9.
                buf[token_offset] = it->second.token.size();
                // –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω –≤ –ø–∞–∫–µ—Ç.
                std::memcpy(buf + token_offset + 1, it->second.token.data(), it->second.token.size());
            }

            // === –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ü–ê–ö–ï–¢–ê –î–û –û–¢–ü–†–ê–í–ö–ò –í –†–§ ===
            LOG_INFO("–ü–∞–∫–µ—Ç –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –†–§:");
            print_hex(reinterpret_cast<uint8_t *>(buf), static_cast<size_t>(n), "SEND_TO_RF");

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞–∫–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            ssize_t sent = sendto(wg_fd, buf, n, 0,
                                  (struct sockaddr *)&backend_addr, sizeof(backend_addr));
            if (sent < 0)
            {
                LOG_ERROR("sendto backend failed: {}", strerror(errno));
            }
            else
            {
                LOG_INFO("–ü–µ—Ä–µ—Å–ª–∞–Ω–æ {} –±–∞–π—Ç –≤ –†–§", sent);
            }
        }
              // === –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï: –°–ï–†–í–ï–† ‚Üí –ö–õ–ò–ï–ù–¢ ===
        if (FD_ISSET(wg_fd, &read_fds))
        {
            // === –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –≤ –†–æ—Å—Å–∏–∏ ===
            ssize_t n = recvfrom(wg_fd, buf, sizeof(buf), 0,
                                 (struct sockaddr *)&backend_addr, &backend_len);
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫—É –∏–ª–∏ –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π —Ä–µ–∂–∏–º.
            if (n < 0 || static_cast<size_t>(n) >= MAX_PACKET_SIZE)
            {
                if (errno != EAGAIN && errno != EWOULDBLOCK)
                {
                    LOG_ERROR("recvfrom backend failed: {}", strerror(errno));
                }
                continue;
            }

            // === –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ü–ê–ö–ï–¢–ê –ü–û–°–õ–ï –ü–û–õ–£–ß–ï–ù–ò–Ø –û–¢ –†–§ (–°–†–ê–ó–£ –ü–û–°–õ–ï recvfrom) ===
            LOG_INFO("–ü–∞–∫–µ—Ç –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç –†–§:");
            print_hex(reinterpret_cast<uint8_t *>(buf), static_cast<size_t>(n), "RECV_FROM_RF");

            // === –í—ã–≤–æ–¥–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ===
            LOG_INFO("=== [SERVER ‚Üí CLIENT] ===");
            LOG_INFO("–ü–æ–ª—É—á–µ–Ω–æ {} –±–∞–π—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞", n);
            print_hex(reinterpret_cast<uint8_t *>(buf), static_cast<size_t>(n), "REPLY_HEADER");

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–∫–µ—Ç–∞. QUIC-–∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–æ—Ä–æ—á–µ 6 –±–∞–π—Ç.
            if (n < 6)
            {
                LOG_WARN("–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –ø–∞–∫–µ—Ç ({}) –±–∞–π—Ç", n);
                continue;
            }

            uint8_t packet_type = buf[0];
            // === –û–±—Ä–∞–±–æ—Ç–∫–∞ Retry-–ø–∞–∫–µ—Ç–∞ ===
            if ((packet_type & 0xC0) == 0xC0)
            { // –≠—Ç–æ Long Header
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–∞–∫–µ—Ç Retry
                // Retry-–ø–∞–∫–µ—Ç –∏–º–µ–µ—Ç –≤ –ø–æ–ª–µ –≤–µ—Ä—Å–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–µ 0x00000000 –∏ –≤ –±–∞–π—Ç–∞—Ö 5-8 ‚Äî –Ω—É–ª–∏.
                if (buf[5] == 0x00 && buf[6] == 0x00 && buf[7] == 0x00 && buf[8] == 0x00)
                {
                    // –≠—Ç–æ Retry-–ø–∞–∫–µ—Ç
                    LOG_INFO("Received Retry packet");
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ Retry-–ø–∞–∫–µ—Ç–∞
                    size_t token_offset = 9;                                                                // –¢–æ–∫–µ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –±–∞–π—Ç–∞ 9
                    size_t token_len = buf[token_offset];                                                   // –î–ª–∏–Ω–∞ —Ç–æ–∫–µ–Ω–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±–∞–π—Ç–µ 9
                    std::vector<uint8_t> token(buf + token_offset + 1, buf + token_offset + 1 + token_len); // –°–∞–º —Ç–æ–∫–µ–Ω

                    // –°–æ–∑–¥–∞—ë–º –∫–ª—é—á –Ω–∞ –æ—Å–Ω–æ–≤–µ IP –∏ –ø–æ—Ä—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–∏–∑ client_addr)
                    ClientKey key{};
                    key.addr = client_addr.sin_addr.s_addr; // IPv4-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞
                    key.port = client_addr.sin_port;        // –ü–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–∞

                    // –ü–µ—Ä–≤—ã–µ 8 –±–∞–π—Ç –ø–æ—Å–ª–µ —Ç–æ–∫–µ–Ω–∞ ‚Äî —ç—Ç–æ SCID (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö –∫–∞–∫ CID)
                    std::memset(key.cid, 0, 8);       // –ó–∞–ø–æ–ª–Ω—è–µ–º cid –Ω—É–ª—è–º–∏
                    std::memcpy(key.cid, buf + 9, 8); // –ö–æ–ø–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ 8 –±–∞–π—Ç –ø–æ—Å–ª–µ —Ç–æ–∫–µ–Ω–∞ ‚Äî —ç—Ç–æ SCID

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ session_map
                    key.token = token;      // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω
                    session_map[key] = key; // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤–µ—Å—å –æ–±—ä–µ–∫—Ç ClientKey –≤ session_map

                    // –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º Retry-–ø–∞–∫–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
                    ssize_t sent = sendto(udp_fd, buf, n, 0,
                                          (struct sockaddr *)&client_addr, sizeof(client_addr));

                    if (sent < 0)
                    {
                        LOG_ERROR("sendto client failed: {}", strerror(errno));
                    }
                    else
                    {
                        LOG_INFO("Retry packet sent to client");
                    }

                    continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —ç—Ç–æ–≥–æ –ø–∞–∫–µ—Ç–∞
                }
            } // === –ö–æ–Ω–µ—Ü –æ–±—Ä–∞–±–æ—Ç–∫–∏ Retry-–ø–∞–∫–µ—Ç–∞ ===

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–∞–∫–µ—Ç Short Header (–±–∏—Ç—ã 7-6 != 11).
            if ((packet_type & 0xC0) != 0xC0)
            {
                LOG_DEBUG("Short Header ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º");
                continue;
            }

            // === –ü–∞—Ä—Å–∏–Ω–≥ –¥–ª–∏–Ω CID ===
            size_t pos = 5;              // –°–º–µ—â–µ–Ω–∏–µ –¥–æ –±–∞–π—Ç–∞ –¥–ª–∏–Ω CID (–±–∞–π—Ç 5)
            uint8_t dcil = buf[pos];     // –î–ª–∏–Ω–∞ DCID (–≤–µ—Ä—Ö–Ω–∏–µ 4 –±–∏—Ç–∞ –±–∞–π—Ç–∞ 5)
            uint8_t scil = buf[pos + 1]; // –î–ª–∏–Ω–∞ SCID (–Ω–∏–∂–Ω–∏–µ 4 –±–∏—Ç–∞ –±–∞–π—Ç–∞ 5)

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–ª–∏–Ω CID.
            if (dcil == 0 || scil == 0 || pos + 2 + dcil + scil > static_cast<size_t>(n))
            {
                LOG_WARN("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ CID –¥–ª–∏–Ω—ã");
                continue;
            }

            // === –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ DCID ===
            uint8_t *dcid = reinterpret_cast<uint8_t *>(&buf[pos + 2]);

            // === –ü–æ–∏—Å–∫ —Å–µ—Å—Å–∏–∏ –ø–æ DCID ===
            // –î–ª—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ —Å–µ—Å—Å–∏—é –ø–æ DCID, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å SCID –∫–ª–∏–µ–Ω—Ç–∞.
            ClientKey key{};
            bool found = false;

            // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–µ—Å—Å–∏–∏ –≤ session_map
            for (const auto &pair : session_map)
            {
                const ClientKey &stored_key = pair.first;
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ DCID –∏–∑ –ø–∞–∫–µ—Ç–∞ —Å SCID, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º –≤ —Å–µ—Å—Å–∏–∏
                // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –±–∞–π—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ DCID –∏ SCID
                size_t compare_len = std::min(static_cast<size_t>(scil), 8UL);
                if (std::memcmp(stored_key.cid, dcid, compare_len) == 0)
                {
                    // –ù–∞—à–ª–∏ —Å–µ—Å—Å–∏—é!
                    key = stored_key;
                    found = true;
                    break;
                }
            }

            if (!found)
            {
                LOG_WARN("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π DCID ‚Äî –ø–∞–∫–µ—Ç –ø–æ—Ç–µ—Ä—è–ª—Å—è");
                continue;
            }

            // === –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∞–∫–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ===
            struct sockaddr_in client_dest{};
            client_dest.sin_family = AF_INET;
            client_dest.sin_addr.s_addr = key.addr;
            client_dest.sin_port = key.port;

            ssize_t sent = sendto(udp_fd, buf, n, 0,
                                  (struct sockaddr *)&client_dest, sizeof(client_dest));

            if (sent < 0)
            {
                LOG_ERROR("sendto client failed: {}", strerror(errno));
            }
            else
            {
                LOG_INFO("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {} –±–∞–π—Ç –∫–ª–∏–µ–Ω—Ç—É {}:{}",
                         sent,
                         inet_ntoa(client_dest.sin_addr),
                         ntohs(client_dest.sin_port));
            }
        }
    }

    std::printf("[INFO] [quic_udp_proxy.cpp:%d] –ü—Ä–æ–∫—Å–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.\n", __LINE__);
    if (udp_fd != -1)
        ::close(udp_fd);
    if (wg_fd != -1)
        ::close(wg_fd);
    return 0;
}

// "quic_udp_proxy.hpp"
/**
 * @file quic_udp_proxy.hpp
 * @brief –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.
 *
 * –ë–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, –∫–∞–∫–∏–µ –∫–ª–∞—Å—Å—ã, —Ñ—É–Ω–∫—Ü–∏–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ–±—ä—è–≤–ª—è–µ—Ç —Ñ–∞–π–ª.
 * –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π –∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
 *
 * @author Telian Edward <telianedward@icloud.com>
 * @assisted-by AI-Assistant
 * @date 2025-09-29
 * @version 1.0
 * @license MIT
 *
 * @note –≠—Ç–æ—Ç —Ñ–∞–π–ª —Ç—Ä–µ–±—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞ C++23 (ISO/IEC 14882:2024).
 * –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è: std::vector, std::unordered_map, std::random_device, std::mt19937.
 *
 * @note –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
 * - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ C++23.
 * - –°–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏: <sys/socket.h>, <netinet/in.h>, <unistd.h>.
 * - –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫.
 */

#pragma once

#include <iostream>
#include <cstring>
#include <unordered_map>
#include <vector>
#include <string>
#include <cstdint>   // –î–ª—è uint8_t, uint16_t, uint32_t
#include <algorithm> // –î–ª—è std::min, std::max
#include <cstdlib>   // –î–ª—è std::srand, std::rand
#include "server/logger.h"
#include "include/client_key.hpp"


// === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===
constexpr char BACKEND_IP[] = "10.8.0.11";   ///< IP —Å–µ—Ä–≤–µ—Ä–∞ –≤ –†–§ —á–µ—Ä–µ–∑ WireGuard
constexpr int BACKEND_PORT = 8585;           ///< –ü–æ—Ä—Ç H3-—Å–µ—Ä–≤–µ—Ä–∞ –≤ –†–§
constexpr int LISTEN_PORT = 443;             ///< –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Å–ª—É—à–∞–µ—Ç –ø—Ä–æ–∫—Å–∏ (HTTPS)
constexpr size_t MAX_PACKET_SIZE = 1500;     ///< –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä UDP-–ø–∞–∫–µ—Ç–∞

static_assert(MAX_PACKET_SIZE <= 65536, "MAX_PACKET_SIZE –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <= 65536");

// === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===

/**
 * @brief –•–µ—à-—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è std::vector<uint8_t>
 *
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è CID –≤ session_map.
 */
struct VectorHash
{
    size_t operator()(const std::vector<uint8_t> &v) const noexcept;
};

/**
 * @brief –û–ø–µ—Ä–∞—Ç–æ—Ä —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–ª—è –≤–µ–∫—Ç–æ—Ä–æ–≤ –±–∞–π—Ç–æ–≤
 *
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è CID –≤ reverse_map.
 */
struct VectorEqual
{
    bool operator()(const std::vector<uint8_t> &a, const std::vector<uint8_t> &b) const noexcept;
};


/**
 * @brief –ú–∞–ø–ø–∏–Ω–≥ –∫–ª—é—á–∞ –∫–ª–∏–µ–Ω—Ç–∞ ‚Üí –ª–æ–∫–∞–ª—å–Ω—ã–π CID.
 *
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ SCID –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.
 */
extern std::unordered_map<ClientKey, ClientKey, ClientKeyHash> session_map;

/**
 * @brief –û–±—Ä–∞—Ç–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥: –ª–æ–∫–∞–ª—å–Ω—ã–π CID ‚Üí –∫–ª—é—á –∫–ª–∏–µ–Ω—Ç–∞.
 *
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ CID –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.
 */
extern std::unordered_map<std::vector<uint8_t>, ClientKey, VectorHash, VectorEqual> reverse_map;

// === –§—É–Ω–∫—Ü–∏–∏ ===

/**
 * @brief –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π —Ä–µ–∂–∏–º —Å–æ–∫–µ—Ç–∞
 * @param fd –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å–æ–∫–µ—Ç–∞
 * @return 0 –ø—Ä–∏ —É—Å–ø–µ—Ö–µ, -1 –ø—Ä–∏ –æ—à–∏–±–∫–µ
 * @throws –ù–∏–∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç.
 */
[[nodiscard]] int set_nonblocking(int fd) noexcept;

/**
 * @brief –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π 8-–±–∞–π—Ç–æ–≤—ã–π CID
 * @return –í–µ–∫—Ç–æ—Ä –∏–∑ 8 —Å–ª—É—á–∞–π–Ω—ã—Ö –±–∞–π—Ç
 * @throws –ù–∏–∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç.
 */
[[nodiscard]] std::vector<uint8_t> generate_local_cid() noexcept;

/**
 * @brief –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–Ω–µ—à–Ω–∏–π IP-–∞–¥—Ä–µ—Å —Å–∏—Å—Ç–µ–º—ã —á–µ—Ä–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ 8.8.8.8:53
 * @param ip_out –°—Ç—Ä–æ–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è IP
 * @return true, –µ—Å–ª–∏ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å
 * @throws –ù–∏–∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç.
 * @warning –ú–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–π IP –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö
 */
[[nodiscard]] bool get_external_ip(std::string &ip_out) noexcept;

/**
 * @brief –í—ã–≤–æ–¥–∏—Ç –±–∞–π—Ç—ã –≤ hex-—Ñ–æ—Ä–º–∞—Ç–µ (–ø–µ—Ä–≤—ã–µ 32 –±–∞–π—Ç–∞)
 * @param data –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –¥–∞–Ω–Ω—ã–µ
 * @param len –î–ª–∏–Ω–∞ –¥–∞–Ω–Ω—ã—Ö
 * @param label –ú–µ—Ç–∫–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "HEADER")
 * @throws –ù–∏–∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç.
 */
void print_hex(const uint8_t *data, size_t len, const std::string &label) noexcept;

/**
 * @brief –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (SIGINT, SIGTERM)
 * @param sig –ù–æ–º–µ—Ä —Å–∏–≥–Ω–∞–ª–∞
 * @throws –ù–∏–∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç.
 */
void signal_handler(int sig);

// "src/client_key.cpp"
/**
 * @file client_key.cpp
 * @brief –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç–æ–¥–æ–≤, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º .h —Ñ–∞–π–ª–µ.
 *
 * –ó–¥–µ—Å—å —Ä–µ–∞–ª–∏–∑—É—é—Ç—Å—è –º–µ—Ç–æ–¥—ã, —É—Ç–∏–ª–∏—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞.
 * –§–∞–π–ª —Ä–∞–±–æ—Ç–∞–µ—Ç —Å PostgreSQL —á–µ—Ä–µ–∑ libpqxx –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º C++23.
 *
 * @author Telian Edward <telianedward@icloud.com>
 * @assisted-by AI-Assistant
 * @date 2025-10-21
 * @version 1.0
 * @license MIT
 */

// src/client_key.cpp
#include "../include/client_key.hpp"

size_t ClientKeyHash::operator()(const ClientKey &k) const noexcept
{
    std::hash<uint32_t> hasher;
    size_t result = hasher(k.addr) ^
                    (std::hash<uint16_t>()(k.port) << 1) ^
                    std::hash<uint64_t>()(*reinterpret_cast<const uint64_t *>(k.cid));
    return result;
}

bool ClientKeyEqual::operator()(const ClientKey &a, const ClientKey &b) const noexcept
{
    return a.addr == b.addr && a.port == b.port &&
           std::memcmp(a.cid, b.cid, 8) == 0 &&
           a.token == b.token; // –î–æ–±–∞–≤–ª–µ–Ω–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
}

bool ClientKey::operator==(const ClientKey &other) const noexcept
{
    return addr == other.addr && port == other.port &&
           std::memcmp(cid, other.cid, 8) == 0 &&
           token == other.token; // –î–æ–±–∞–≤–ª–µ–Ω–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
}

// "src/quic_udp_deduplicator.cpp"
/**
 * @file quic_udp_deduplicator.cpp
 * @brief –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç–æ–¥–æ–≤, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º .h —Ñ–∞–π–ª–µ.
 *
 * –ó–¥–µ—Å—å —Ä–µ–∞–ª–∏–∑—É—é—Ç—Å—è –º–µ—Ç–æ–¥—ã, —É—Ç–∏–ª–∏—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞.
 * –§–∞–π–ª —Ä–∞–±–æ—Ç–∞–µ—Ç —Å PostgreSQL —á–µ—Ä–µ–∑ libpqxx –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º C++23.
 *
 * @author Telian Edward <telianedward@icloud.com>
 * @assisted-by AI-Assistant
 * @date 2025-10-21
 * @version 1.0
 * @license MIT
 */
// src/quic_udp_deduplicator.cpp
#include "../include/quic_udp_deduplicator.hpp"
#include "../include/client_key.hpp"
#include <cstring>

size_t Deduplicator::PacketKeyHash::operator()(const PacketKey &key) const noexcept
{
    size_t result = 0;
    // –•—ç—à–∏—Ä—É–µ–º ClientKey
    result ^= std::hash<uint32_t>()(key.client_key.addr);
    result ^= std::hash<uint16_t>()(key.client_key.port);
    for (uint8_t b : key.client_key.cid)
    {
        result ^= std::hash<uint8_t>()(b) + 2654435761U + (result << 6) + (result >> 2);
    }
    // –•—ç—à–∏—Ä—É–µ–º SCID
    for (uint8_t b : key.scid)
    {
        result ^= std::hash<uint8_t>()(b) + 2654435761U + (result << 6) + (result >> 2);
    }
    // –•—ç—à–∏—Ä—É–µ–º DCID
    for (uint8_t b : key.dcid)
    {
        result ^= std::hash<uint8_t>()(b) + 2654435761U + (result << 6) + (result >> 2);
    }
    // –•—ç—à–∏—Ä—É–µ–º Packet Number
    result ^= std::hash<uint64_t>()(key.packet_number);
    return result;
}

bool Deduplicator::PacketKeyEqual::operator()(const PacketKey &a, const PacketKey &b) const noexcept
{
    return a.client_key == b.client_key &&
           a.scid == b.scid &&
           a.dcid == b.dcid &&
           a.packet_number == b.packet_number;
}

void Deduplicator::add_packet(const ClientKey &key, const PacketInfo &info)
{
    PacketKey packet_key{};
    packet_key.client_key = key;
    packet_key.scid = info.scid;
    packet_key.dcid = {}; // DCID –ø–æ–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω, –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∂–µ
    packet_key.packet_number = info.packet_number;

    seen_packets_[packet_key] = true;
}

bool Deduplicator::is_duplicate(const ClientKey &key, const std::vector<uint8_t> &scid, const std::vector<uint8_t> &dcid, uint64_t packet_number) const
{
    PacketKey packet_key{};
    packet_key.client_key = key;
    packet_key.scid = scid;
    packet_key.dcid = dcid;
    packet_key.packet_number = packet_number;

    auto it = seen_packets_.find(packet_key);
    if (it != seen_packets_.end())
    {
        return true; // –≠—Ç–æ –¥—É–±–ª–∏–∫–∞—Ç
    }

    return false; // –≠—Ç–æ –ø–µ—Ä–≤—ã–π –ø–∞–∫–µ—Ç
}

void Deduplicator::remove_connection(const ClientKey &key)
{
    (void)key; // –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è "unused parameter"
}

// "server/logger.h"
/**
 * @file logger.hpp
 * @brief –õ–æ–≥–≥–µ—Ä –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ C++20/23 —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ü–≤–µ—Ç–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞—Ö–≤–∞—Ç–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
 *
 * –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å —É—Ä–æ–≤–Ω—è–º–∏ (DEBUG, INFO, WARN, ERROR, SUCCESS),
 * –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Ñ–∞–π–ª–∞, —Å—Ç—Ä–æ–∫–∏, —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏.
 * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ü–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ (ANSI escape codes) –∏ —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–ª–∏—á–µ–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π.
 * –¢–∞–∫–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç LOG_RAW –¥–ª—è –ø—Ä—è–º–æ–≥–æ –≤—ã–≤–æ–¥–∞ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫).
 *
 * @author Telian Edward <telianedward@icloud.com>
 * @assisted-by AI-Assistant
 * @date 2025-09-29
 * @version 1.0
 * @license MIT
 */

#pragma once

#include <string>
#include <source_location>
#include <chrono>
#include <iostream>
#include <iomanip>
#include <mutex>

#ifdef _WIN32
    #include <io.h>
    #include <fcntl.h>
#else
    #include <unistd.h>
#endif

// –î–ª—è fmt::format
#include <fmt/core.h>

/**
 * @brief –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
 */
enum class LogLevel {
    DEBUG,   ///< –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
    INFO,    ///< –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å
    WARN,    ///< –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–≤–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞)
    ERROR,   ///< –û—à–∏–±–∫–∞ (–Ω–∞—Ä—É—à–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞)
    SUCCESS  ///< –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–≤–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è)
};

/**
 * @brief –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º—ë–Ω –¥–ª—è –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –ª–æ–≥–≥–µ—Ä–∞.
 *
 * –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–º–µ—é—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –ª–∏–Ω–∫–æ–≤–∫—É (static linkage) –±–ª–∞–≥–æ–¥–∞—Ä—è –∞–Ω–æ–Ω–∏–º–Ω–æ–º—É namespace.
 */
namespace {

/**
 * @brief –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ANSI-–∫–æ–¥ —Ü–≤–µ—Ç–∞ –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
 * @param level –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
 * @return –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä–æ–∫—É —Å ANSI-–∫–æ–¥–æ–º —Ü–≤–µ—Ç–∞.
 */
const char* get_color_code(LogLevel level) {
    switch (level) {
        case LogLevel::DEBUG:   return "\033[36m"; // Cyan
        case LogLevel::INFO:    return "\033[34m"; // Blue
        case LogLevel::WARN:    return "\033[33m"; // Yellow
        case LogLevel::ERROR:   return "\033[31m"; // Red
        case LogLevel::SUCCESS: return "\033[32m"; // Green
        default:                return "\033[0m";
    }
}

/**
 * @brief –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–º–æ–¥–∑–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —É—Ä–æ–≤–Ω—é –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
 * @param level –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
 * @return –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä–æ–∫–æ–≤—ã–π –ª–∏—Ç–µ—Ä–∞–ª —Å —ç–º–æ–¥–∑–∏ –≤ –∫–æ–¥–∏—Ä–æ–≤–∫–µ UTF-8.
 * @warning –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ UTF-8 –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
 */
const char* get_emoji(LogLevel level) {
    switch (level) {
        case LogLevel::DEBUG:   return "üíü";
        case LogLevel::INFO:    return "üîµ";
        case LogLevel::WARN:    return "‚ö†Ô∏è";
        case LogLevel::ERROR:   return "‚ùå";
        case LogLevel::SUCCESS: return "‚úÖ";
        default:                return "";
    }
}

/**
 * @brief ANSI-–∫–æ–¥ –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ.
 */
const char* reset_color = "\033[0m";

/**
 * @brief –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ stdout —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–º.
 * @return true, –µ—Å–ª–∏ stdout –ø–æ–¥–∫–ª—é—á—ë–Ω –∫ TTY.
 */
bool is_stdout_tty() {
#ifdef _WIN32
    return _isatty(_fileno(stdout));
#else
    return isatty(fileno(stdout));
#endif
}

/**
 * @brief –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–ì–ì–ì–ì-–ú–ú-–î–î –ß–ß:–ú–ú:–°–°".
 * @return –°—Ç—Ä–æ–∫–∞ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ.
 * @throws std::runtime_error –ü—Ä–∏ –æ—à–∏–±–∫–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏.
 * @warning –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (localtime_r / localtime_s).
 */
std::string get_timestamp() {
    try {
        auto now = std::chrono::system_clock::now();
        auto time_t = std::chrono::system_clock::to_time_t(now);

#ifdef _WIN32
        std::tm local_time;
        if (std::localtime_s(&local_time, &time_t) != 0) {
            throw std::runtime_error("localtime_s failed");
        }
#else
        std::tm local_time;
        if (::localtime_r(&time_t, &local_time) == nullptr) {
            throw std::runtime_error("localtime_r failed");
        }
#endif

        char buffer[20];
        if (std::strftime(buffer, sizeof(buffer), "%Y-%m-%d %H:%M:%S", &local_time) == 0) {
            throw std::runtime_error("strftime failed");
        }
        return std::string(buffer);
    } catch (const std::exception& e) {
        return "TIMESTAMP_ERROR";
    }
}

/**
 * @brief –ú—å—é—Ç–µ–∫—Å –¥–ª—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ª–æ–≥–≥–µ—Ä–∞.
 *
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—ã–≤–æ–¥–∞ –≤ cerr.
 * –ú–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω, –µ—Å–ª–∏ –ª–æ–≥–≥–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ.
 */
std::mutex log_mutex;

} // namespace

/**
 * @brief –û—Å–Ω–æ–≤–Ω–∞—è —à–∞–±–ª–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.
 *
 * –ù–µ –≤—ã–∑—ã–≤–∞–π—Ç–µ –Ω–∞–ø—Ä—è–º—É—é ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∞–∫—Ä–æ—Å—ã LOG_DEBUG, LOG_INFO –∏ —Ç.–¥.
 *
 * @tparam Args –¢–∏–ø—ã –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
 * @param level –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
 * @param location –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–µ –≤—ã–∑–æ–≤–∞ (–æ–±—ã—á–Ω–æ std::source_location::current()).
 * @param format_str –°—Ç—Ä–æ–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ (—Å–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å fmt::format).
 * @param args –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ —Å—Ç—Ä–æ–∫—É —Ñ–æ—Ä–º–∞—Ç–∞.
 * @throws –ù–∏–∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç.
 */
template<typename... Args>
void log_impl(LogLevel level,
              const std::source_location& location = std::source_location::current(),
              std::string_view format_str = "",
              Args&&... args) {
    const bool use_color = is_stdout_tty();
    const char* color_start = use_color ? get_color_code(level) : "";
    const char* color_reset = use_color ? reset_color : "";

    const char* level_name = [&]() -> const char* {
        switch (level) {
            case LogLevel::DEBUG:   return "DEBUG";
            case LogLevel::INFO:    return "INFO";
            case LogLevel::WARN:    return "WARN";
            case LogLevel::ERROR:   return "ERROR";
            case LogLevel::SUCCESS: return "SUCCESS";
            default:                return "UNKNOWN";
        }
    }();

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º fmt::runtime, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ "not a constant expression"
    std::string message = fmt::format(fmt::runtime(format_str), args...);

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º—å—é—Ç–µ–∫—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
    std::lock_guard<std::mutex> lock(log_mutex);

    // –í—ã–≤–æ–¥–∏–º –≤ cerr
    std::cerr << color_start
              << "[" << get_timestamp() << "] "
              << get_emoji(level) << "[" << level_name << "] "
              << "[" << location.file_name() << ":" << location.line() << " in " << location.function_name() << "] "
              << message
              << color_reset
              << std::endl;
}

/**
 * @brief –§—É–Ω–∫—Ü–∏—è –¥–ª—è "—Å—ã—Ä–æ–≥–æ" –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
 *
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, quiche),
 * –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç –≥–æ—Ç–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–æ–≤.
 *
 * @tparam Args –¢–∏–ø—ã –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
 * @param format_str –°—Ç—Ä–æ–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞.
 * @param args –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏.
 * @throws –ù–∏–∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç.
 */
template<typename... Args>
void log_raw_impl(const std::string& format_str, Args&&... args) {
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    std::string message = fmt::format(fmt::runtime(format_str), args...);

    // –í—ã–≤–æ–¥–∏–º –≤ cerr
    std::cerr << message << std::endl;
}

/**
 * @brief –ú–∞–∫—Ä–æ—Å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è DEBUG.
 * @param ... –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å fmt::format).
 * @throws –ù–∏–∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç.
 * @warning –ò—Å–ø–æ–ª—å–∑—É–µ—Ç __FILE__, __LINE__, __func__ ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º –≤ release-—Å–±–æ—Ä–∫–µ.
 */
#define LOG_DEBUG(...) log_impl(LogLevel::DEBUG, std::source_location::current(), __VA_ARGS__)

/**
 * @brief –ú–∞–∫—Ä–æ—Å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è INFO.
 * @param ... –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å fmt::format).
 * @throws –ù–∏–∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç.
 * @warning –ò—Å–ø–æ–ª—å–∑—É–µ—Ç __FILE__, __LINE__, __func__ ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º –≤ release-—Å–±–æ—Ä–∫–µ.
 */
#define LOG_INFO(...)  log_impl(LogLevel::INFO,  std::source_location::current(), __VA_ARGS__)

/**
 * @brief –ú–∞–∫—Ä–æ—Å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è WARN.
 * @param ... –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å fmt::format).
 * @throws –ù–∏–∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç.
 * @warning –ò—Å–ø–æ–ª—å–∑—É–µ—Ç __FILE__, __LINE__, __func__ ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º –≤ release-—Å–±–æ—Ä–∫–µ.
 */
#define LOG_WARN(...)  log_impl(LogLevel::WARN,  std::source_location::current(), __VA_ARGS__)

/**
 * @brief –ú–∞–∫—Ä–æ—Å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è ERROR.
 * @param ... –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å fmt::format).
 * @throws –ù–∏–∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç.
 * @warning –ò—Å–ø–æ–ª—å–∑—É–µ—Ç __FILE__, __LINE__, __func__ ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º –≤ release-—Å–±–æ—Ä–∫–µ.
 */
#define LOG_ERROR(...) log_impl(LogLevel::ERROR, std::source_location::current(), __VA_ARGS__)

/**
 * @brief –ú–∞–∫—Ä–æ—Å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è SUCCESS.
 * @param ... –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å fmt::format).
 * @throws –ù–∏–∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç.
 * @warning –ò—Å–ø–æ–ª—å–∑—É–µ—Ç __FILE__, __LINE__, __func__ ‚Äî –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º –≤ release-—Å–±–æ—Ä–∫–µ.
 */
#define LOG_SUCCESS(...) log_impl(LogLevel::SUCCESS, std::source_location::current(), __VA_ARGS__)

/**
 * @brief –ú–∞–∫—Ä–æ—Å –¥–ª—è "—Å—ã—Ä–æ–≥–æ" –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–≤—Ä–µ–º—è, —Ñ–∞–π–ª, —Ñ—É–Ω–∫—Ü–∏—è –∏ —Ç.–¥.).
 *
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
 * –∏–ª–∏ –ø–æ—Å—Ç—É–ø–∞–µ—Ç –∏–∑ –≤–Ω–µ—à–Ω–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.
 *
 * @param ... –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å fmt::format).
 * @throws –ù–∏–∫–∞–∫–∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç.
 * @warning –ù–µ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏, —É—Ä–æ–≤–Ω–∏ –∏–ª–∏ —ç–º–æ–¥–∑–∏ ‚Äî —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–Ω–æ.
 */
#define LOG_RAW(...) log_raw_impl(__VA_ARGS__)

// "include/client_key.hpp"
// include/client_key.hpp
/**
 * @file client_key.hpp
 * @brief –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.
 *
 * –ë–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, –∫–∞–∫–∏–µ –∫–ª–∞—Å—Å—ã, —Ñ—É–Ω–∫—Ü–∏–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ–±—ä—è–≤–ª—è–µ—Ç —Ñ–∞–π–ª.
 * –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π –∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
 *
 * @author Telian Edward <telianedward@icloud.com>
 * @assisted-by AI-Assistant
 * @date 2025-10-21
 * @version 1.0
 * @license MIT
 */
#pragma once
#include <vector>
#include <cstdint>
#include <cstring>
#include <unordered_map>

/**
 * @brief –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª—é—á–∞ –∫–ª–∏–µ–Ω—Ç–∞.
 *
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∫–ª—é—á –≤ session_map –∏ Deduplicator.
 */
struct ClientKey {
    uint32_t addr;          ///< IPv4-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞
    uint16_t port;          ///< –ü–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–∞
    uint8_t cid[8];         ///< –ü–µ—Ä–≤—ã–µ 8 –±–∞–π—Ç SCID
    std::vector<uint8_t> token; ///< –¢–æ–∫–µ–Ω –∏–∑ Retry-–ø–∞–∫–µ—Ç–∞

    bool operator==(const ClientKey &other) const noexcept;
};

/**
 * @brief –•–µ—à-—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è ClientKey.
 */
struct ClientKeyHash {
    size_t operator()(const ClientKey &k) const noexcept;
};

/**
 * @brief –û–ø–µ—Ä–∞—Ç–æ—Ä —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–ª—è ClientKey.
 */
struct ClientKeyEqual {
    bool operator()(const ClientKey &a, const ClientKey &b) const noexcept;
};


// "include/quic_udp_deduplicator.hpp"
/**
 * @file quic_udp_deduplicator.hpp
 * @brief –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.
 *
 * –ë–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, –∫–∞–∫–∏–µ –∫–ª–∞—Å—Å—ã, —Ñ—É–Ω–∫—Ü–∏–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ–±—ä—è–≤–ª—è–µ—Ç —Ñ–∞–π–ª.
 * –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π –∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
 *
 * @author Telian Edward <telianedward@icloud.com>
 * @assisted-by AI-Assistant
 * @date 2025-10-21
 * @version 1.0
 * @license MIT
 */
// include/quic_udp_deduplicator.hpp
// include/quic_udp_deduplicator.hpp

#pragma once
#include <unordered_map>
#include <vector>
#include <cstdint>
#include <string>
#include "client_key.hpp"

/**
 * @brief –ö–ª–∞—Å—Å –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ QUIC-–ø–∞–∫–µ—Ç–æ–≤.
 *
 * –•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–≤–æ–º Initial-–ø–∞–∫–µ—Ç–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞.
 * –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–∞–∫–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–º.
 */
class Deduplicator {
public:
    /**
     * @brief –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–µ—Ä–≤–æ–º Initial-–ø–∞–∫–µ—Ç–µ.
     */
    struct PacketInfo {
        std::vector<uint8_t> token; ///< –¢–æ–∫–µ–Ω –∏–∑ Retry-–ø–∞–∫–µ—Ç–∞
        std::vector<uint8_t> scid;  ///< SCID –∏–∑ –ø–µ—Ä–≤–æ–≥–æ Initial-–ø–∞–∫–µ—Ç–∞
        uint64_t packet_number;     ///< –ù–æ–º–µ—Ä –ø–∞–∫–µ—Ç–∞
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    };

    /**
     * @brief –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –∫–ª—é—á–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏.
     */
    struct PacketKey {
        ClientKey client_key;       ///< –ö–ª—é—á –∫–ª–∏–µ–Ω—Ç–∞ (IP + –ø–æ—Ä—Ç)
        std::vector<uint8_t> scid;  ///< SCID
        std::vector<uint8_t> dcid;  ///< DCID
        uint64_t packet_number;     ///< –ù–æ–º–µ—Ä –ø–∞–∫–µ—Ç–∞
    };

    /**
     * @brief –•–µ—à-—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è PacketKey.
     */
    struct PacketKeyHash {
        size_t operator()(const PacketKey &key) const noexcept;
    };

    /**
     * @brief –û–ø–µ—Ä–∞—Ç–æ—Ä —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –¥–ª—è PacketKey.
     */
    struct PacketKeyEqual {
        bool operator()(const PacketKey &a, const PacketKey &b) const noexcept;
    };

    /**
     * @brief –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä.
     */
    Deduplicator() = default;

    /**
     * @brief –î–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–≤–æ–º Initial-–ø–∞–∫–µ—Ç–µ.
     * @param key –ö–ª—é—á –∫–ª–∏–µ–Ω—Ç–∞.
     * @param info –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–∫–µ—Ç–µ.
     */
    void add_packet(const ClientKey &key, const PacketInfo &info);

    /**
     * @brief –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–∞–∫–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–º.
     * @param key –ö–ª—é—á –∫–ª–∏–µ–Ω—Ç–∞.
     * @param scid SCID –∏–∑ –ø–∞–∫–µ—Ç–∞.
     * @param dcid DCID –∏–∑ –ø–∞–∫–µ—Ç–∞.
     * @param packet_number –ù–æ–º–µ—Ä –ø–∞–∫–µ—Ç–∞.
     * @return true, –µ—Å–ª–∏ –ø–∞–∫–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–π, false ‚Äî –∏–Ω–∞—á–µ.
     */
    [[nodiscard]] bool is_duplicate(const ClientKey &key, const std::vector<uint8_t> &scid, const std::vector<uint8_t> &dcid, uint64_t packet_number) const;

    /**
     * @brief –£–¥–∞–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏.
     * @param key –ö–ª—é—á –∫–ª–∏–µ–Ω—Ç–∞.
     */
    void remove_connection(const ClientKey &key);

private:
    std::unordered_map<PacketKey, bool, PacketKeyHash, PacketKeyEqual> seen_packets_;
};